from pathlib import Path
import sys

sys.path.append(str(Path(__file__).parents[1]))


import yaml
import json
from copy import deepcopy

from prompting.Exemplars import ListExemplars
from prompting.structured.xml_utils import enclose_in_xml
from prompting.structured.json_utils import texts_to_jsons
from models import HFGenerativeLM

from prepostprocess.extraction_utils import (
    exemplar_json_to_text,
    prepare_prompt_inputs,
)

with open("config/vulnerability_extraction.yaml", "r") as f:
    config = yaml.safe_load(f)

with open(config["exemplars"]["filepath"], "r") as f:
    data = json.load(f)

    exemplars = data[config["exemplars"]["exemplars_key"]]
    exemplars = exemplar_json_to_text(
        exemplars,
        json_key=config["exemplars"]["response_key"],
        **config["exemplars"]["response_conversion_kwargs"],
    )

    system_prompt = data[config["exemplars"]["prompt_key"]]

xml_template = enclose_in_xml(config["template"])
system_prompt = system_prompt.format(xml_template=xml_template)
exemplars = ListExemplars(exemplars=exemplars)

vulnerabilities = [
    "CRLF injection vulnerability in xterm allows user-assisted attackers to execute arbitrary commands via LF (aka \\n) characters surrounding a command name within a Device Control Request Status String (DECRQSS) escape sequence in a text file, a related issue to CVE-2003-0063 and CVE-2003-0071.",
    'The WebWork 1 web application framework in Atlassian JIRA before 3.13.2 allows remote attackers to invoke exposed public JIRA methods via a crafted URL that is dynamically transformed into method calls, aka "WebWork 1 Parameter Injection Hole."',
]

vuln_inp = prepare_prompt_inputs(
    vulnerabilities,
    system_prompt=system_prompt,
    exemplars=exemplars,
    query_key=config["exemplars"]["query_key"],
    response_key=config["exemplars"]["response_key"],
    return_as_text=True,
    **config["exemplars"]["sample_kwargs"],
)

model = HFGenerativeLM(**config["model"]["init_kwargs"])
vuln_json = model.generate(
    vuln_inp,
    generation_config=config["model"]["generation_config"],
    process_text=texts_to_jsons,
)

print(vuln_json)
